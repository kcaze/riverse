var sonantx;
(function(){function a(a){return Math.sin(6.283184*a)}function d(a,d){setTimeout(function(){var c=new Uint8Array(4*a),e=c.length-2,f=function(){for(var a=new Date,b=0;0<=e;)if(c[e]=0,c[e+1]=128,e-=2,b+=1,0===b%1E3&&100<new Date-a){setTimeout(f,0);return}setTimeout(function(){d(c)},0)};setTimeout(f,0)},0)}function c(a,d,c,e,f){var g=c.fx_delay_time*e>>1,b=c.fx_delay_amt/255,h=0,q=function(){for(var c=new Date,e=0;h<d-g;){var p=4*h,u=4*(h+g),m=a[u]+(a[u+1]<<8)+(a[p+2]+(a[p+3]<<8)-32768)*b;a[u]=m&255;
a[u+1]=m>>8&255;m=a[u+2]+(a[u+3]<<8)+(a[p]+(a[p+1]<<8)-32768)*b;a[u+2]=m&255;a[u+3]=m>>8&255;++h;e+=1;if(0===e%1E3&&100<new Date-c){setTimeout(q,0);return}}setTimeout(f,0)};setTimeout(q,0)}sonantx={};var e=null,f=[a,function(d){return 0>a(d)?-1:1},function(a){return a%1-.5},function(a){a=a%1*4;return 2>a?a-1:3-a}];sonantx.AudioGenerator=function(a){this.mixBuf=a;this.waveSize=a.length/2/2};sonantx.AudioGenerator.prototype.getWave=function(){var a=this.mixBuf,d,c,e,f,g,b=4*this.waveSize;d=b-8;c=d-
36;f=String.fromCharCode(82,73,70,70,d&255,d>>8&255,d>>16&255,d>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,c&255,c>>8&255,c>>16&255,c>>24&255);for(d=0;d<b;){e="";for(c=0;256>c&&d<b;++c,d+=2)g=4*(a[d]+(a[d+1]<<8)-32768),g=-32768>g?-32768:32767<g?32767:g,e+=String.fromCharCode(g&255,g>>8&255);f+=e}return f};sonantx.AudioGenerator.prototype.getAudio=function(){var a=this.getWave(),a=new Audio("data:audio/wav;base64,"+btoa(a));a.preload="none";a.load();
return a};sonantx.AudioGenerator.prototype.getAudioBuffer=function(a){null===e&&(e=new AudioContext);var d=this.mixBuf,c=this.waveSize,f=e.createBuffer(2,this.waveSize,44100),v=f.getChannelData(0),g=f.getChannelData(1),b=0,h=function(){for(var e=new Date,k=0;b<c;){var l=4*(d[4*b]+(d[4*b+1]<<8)-32768),l=-32768>l?-32768:32767<l?32767:l;v[b]=l/32768;l=4*(d[4*b+2]+(d[4*b+3]<<8)-32768);l=-32768>l?-32768:32767<l?32767:l;g[b]=l/32768;b+=1;k+=1;if(0===k%1E3&&100<new Date-e){setTimeout(h,0);return}}setTimeout(function(){a(f)},
0)};setTimeout(h,0)};sonantx.SoundGenerator=function(a,d){this.instr=a;this.rowLen=d||5605;this.osc_lfo=f[a.lfo_waveform];this.osc1=f[a.osc1_waveform];this.osc2=f[a.osc2_waveform];this.attack=a.env_attack;this.sustain=a.env_sustain;this.release=a.env_release;this.panFreq=Math.pow(2,a.fx_pan_freq-8)/this.rowLen;this.lfoFreq=Math.pow(2,a.lfo_freq-8)/this.rowLen};sonantx.SoundGenerator.prototype.genSound=function(d,c,e){var f=0,v=0,g=.00390625*Math.pow(1.059463094,d+12*(this.instr.osc1_oct-8)+this.instr.osc1_det-
128)*(1+8E-4*this.instr.osc1_detune);d=.00390625*Math.pow(1.059463094,d+12*(this.instr.osc2_oct-8)+this.instr.osc2_det-128)*(1+8E-4*this.instr.osc2_detune);for(var b=this.instr.fx_resonance/255,h=0,q=0,k=this.attack+this.sustain+this.release-1;0<=k;--k){var l=k+e,p=this.osc_lfo(l*this.lfoFreq)*this.instr.lfo_amt/512+.5,u=1;k<this.attack?u=k/this.attack:k>=this.attack+this.sustain&&(u-=(k-this.attack-this.sustain)/this.release);var m=g;this.instr.lfo_osc1_freq&&(m+=p);this.instr.osc1_xenv&&(m=m*u*
u);var f=f+m,r=this.osc1(f)*this.instr.osc1_vol,m=d;this.instr.osc2_xenv&&(m=m*u*u);v+=m;r+=this.osc2(v)*this.instr.osc2_vol;this.instr.noise_fader&&(r+=(2*Math.random()-1)*this.instr.noise_fader*u);r*=u/255;m=this.instr.fx_freq;this.instr.lfo_fx_freq&&(m*=p);m=1.5*Math.sin(3.141592*m/44100);h+=m*q;p=b*(r-q)-h;q+=m*p;switch(this.instr.fx_filter){case 1:r=p;break;case 2:r=h;break;case 3:r=q;break;case 4:r=h+p}m=a(l*this.panFreq)*this.instr.fx_pan_amt/512+.5;r=39*r*this.instr.env_master;l*=4;l+3<c.length&&
(p=c[l]+(c[l+1]<<8)+r*(1-m),c[l]=p&255,c[l+1]=p>>8&255,p=c[l+2]+(c[l+3]<<8)+r*m,c[l+2]=p&255,c[l+3]=p>>8&255)}};sonantx.SoundGenerator.prototype.getAudioGenerator=function(a,e){var f=this.attack+this.sustain+this.release-1+32*this.rowLen,x=this;d(f,function(d){x.genSound(a,d,0);c(d,f,x.instr,x.rowLen,function(){e(new sonantx.AudioGenerator(d))})})};sonantx.SoundGenerator.prototype.createAudio=function(a,d){this.getAudioGenerator(a,function(a){d(a.getAudio())})};sonantx.SoundGenerator.prototype.createAudioBuffer=
function(a,d){this.getAudioGenerator(a,function(a){a.getAudioBuffer(d)})};sonantx.MusicGenerator=function(a){this.song=a;this.waveSize=44100*a.songLen};sonantx.MusicGenerator.prototype.generateTrack=function(a,e,f){var x=this;d(this.waveSize,function(d){var g=x.waveSize,b=4*x.waveSize,h=x.song.rowLen,q=new sonantx.SoundGenerator(a,h),k=a.notes.length,l=0,p=0,u=function(){for(var b=new Date;;){if(p===k){setTimeout(m,0);break}var c=a.notes[p];c&&q.genSound(c,d,l);p++;l+=3*h;if(100<new Date-b){setTimeout(u,
0);break}}},m=function(){c(d,g,a,h,L)},r=0,L=function(){for(var a=new Date,c=0;r<b;){var p=e[r]+(e[r+1]<<8)+d[r]+(d[r+1]<<8)-32768;e[r]=p&255;e[r+1]=p>>8&255;r+=2;c+=1;if(0===c%1E3&&100<new Date-a){setTimeout(L,0);return}}setTimeout(f,0)};setTimeout(u,0)})};sonantx.MusicGenerator.prototype.getAudioGenerator=function(a){var c=this;d(this.waveSize,function(d){var e=0,f=function(){e<c.song.songData.length?(e+=1,c.generateTrack(c.song.songData[e-1],d,f)):a(new sonantx.AudioGenerator(d))};f()})};sonantx.MusicGenerator.prototype.createAudio=
function(a){this.getAudioGenerator(function(d){a(d.getAudio())})};sonantx.MusicGenerator.prototype.createAudioBuffer=function(a){this.getAudioGenerator(function(d){d.getAudioBuffer(a)})}})();function SfxrParams(){this.setSettings=function(a){for(var d=0;24>d;d++)this[String.fromCharCode(97+d)]=a[d]||0;.01>this.c&&(this.c=.01);a=this.b+this.c+this.e;.18>a&&(a=.18/a,this.b*=a,this.c*=a,this.e*=a)}}
function SfxrSynth(){this._params=new SfxrParams;var a,d,c,e,f,n,y,w,x,v,g,b;this.reset=function(){var a=this._params;e=100/(a.f*a.f+.001);f=100/(a.g*a.g+.001);n=1-a.h*a.h*a.h*.01;y=-a.i*a.i*a.i*1E-6;a.a||(g=.5-a.n/2,b=5E-5*-a.o);w=1+a.l*a.l*(0<a.l?-.9:10);x=0;v=1==a.m?0:(1-a.m)*(1-a.m)*2E4+32};this.totalReset=function(){this.reset();var b=this._params;a=b.b*b.b*1E5;d=b.c*b.c*1E5;c=b.e*b.e*1E5+12;return 3*((a+d+c)/3|0)};this.synthWave=function(h,q){var k=this._params,l=1!=k.s||k.v,p=k.v*k.v*.1,u=
1+3E-4*k.w,m=k.s*k.s*k.s*.1,r=1+1E-4*k.t,L=1!=k.s,Z=k.x*k.x,aa=k.g,U=k.q||k.r,ba=k.r*k.r*k.r*.2,O=k.q*k.q*(0>k.q?-1020:1020),V=k.p?((1-k.p)*(1-k.p)*2E4|0)+32:0,A=k.d,W=k.j/2,ca=k.k*k.k*.01,P=k.a,Q=a,da=1/a,ea=1/d,fa=1/c,k=5/(1+k.u*k.u*20)*(.01+m);.8<k&&(k=.8);for(var k=1-k,R=!1,X=0,H=0,I=0,M=0,F=0,J,G=0,z,C=0,E,S=0,t,Y=0,D,T=0,N=Array(1024),K=Array(32),B=N.length;B--;)N[B]=0;for(B=K.length;B--;)K[B]=2*Math.random()-1;for(B=0;B<q;B++){if(R)return B;V&&++Y>=V&&(Y=0,this.reset());v&&++x>=v&&(v=0,e*=
w);n+=y;e*=n;e>f&&(e=f,0<aa&&(R=!0));z=e;0<W&&(T+=ca,z*=1+Math.sin(T)*W);z|=0;8>z&&(z=8);P||(g+=b,0>g?g=0:.5<g&&(g=.5));if(++H>Q)switch(H=0,++X){case 1:Q=d;break;case 2:Q=c}switch(X){case 0:I=H*da;break;case 1:I=1+2*(1-H*ea)*A;break;case 2:I=1-H*fa;break;case 3:I=0,R=!0}U&&(O+=ba,E=O|0,0>E?E=-E:1023<E&&(E=1023));l&&u&&(p*=u,1E-5>p?p=1E-5:.1<p&&(p=.1));D=0;for(var ga=8;ga--;){C++;if(C>=z&&(C%=z,3==P))for(J=K.length;J--;)K[J]=2*Math.random()-1;switch(P){case 0:t=C/z<g?.5:-.5;break;case 1:t=1-C/z*2;
break;case 2:t=C/z;t=6.28318531*(.5<t?t-1:t);t=1.27323954*t+.405284735*t*t*(0>t?1:-1);t=.225*((0>t?-1:1)*t*t-t)+t;break;case 3:t=K[Math.abs(32*C/z|0)]}l&&(J=G,m*=r,0>m?m=0:.1<m&&(m=.1),L?(F+=(t-G)*m,F*=k):(G=t,F=0),G+=F,M+=G-J,t=M*=1-p);U&&(N[S%1024]=t,t+=N[(S-E+1024)%1024],S++);D+=t}D=.125*D*I*Z;h[B]=1<=D?32767:-1>=D?-32768:32767*D|0}return q}}var synth=new SfxrSynth;
window.jsfxr=function(a){synth._params.setSettings(a);var d=synth.totalReset();a=new Uint8Array(4*((d+1)/2|0)+44);var d=2*synth.synthWave(new Uint16Array(a.buffer,44),d),c=new Uint32Array(a.buffer,0,44);c[0]=1179011410;c[1]=d+36;c[2]=1163280727;c[3]=544501094;c[4]=16;c[5]=65537;c[6]=44100;c[7]=88200;c[8]=1048578;c[9]=1635017060;c[10]=d;for(var d=d+44,c=0,e="data:audio/wav;base64,";c<d;c+=3)var f=a[c]<<16|a[c+1]<<8|a[c+2],e=e+("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[f>>18]+
"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[f>>12&63]+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[f>>6&63]+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[f&63]);return e};
for(var kz={loadResources:function(a){var d=[];kz.resources={};d.push(kz.loadImages(a.images));d.push(kz.loadSounds(a.sounds));return Promise.all(d).then(function(){return kz.resources})},loadImages:function(a){var d={},c=[],e;for(e in a)c.push(new Promise(function(c){d[e]=new Image;d[e].addEventListener("load",c);d[e].src=a[e]}));return Promise.all(c).then(function(){kz.resources.images=d;return kz.resources.images})},loadSounds:function(a){kz.audio_context=new AudioContext;var d={},c=[],e;for(e in a)c.push(new Promise(function(c){var n=
e;a[e].loader(a[e].data,function(a){console.log("Loaded ",n);d[n]={play:function(a){a=void 0==typeof a?!1:a;var d=kz.audio_context.createBufferSource();d.loop=a;d.buffer=this.buffer;d.connect(kz.audio_context.destination);d.start(0)},buffer:a};c()})}));return Promise.all(c).then(function(){kz.resources.sounds=d;return kz.resources.sounds})},KEYS:{ENTER:13,ESCAPE:27,SPACE:32,LEFT:37,RIGHT:39,Z:90},keys_status:{}},ii=0;256>ii;ii++)kz.keys_status[ii]=0;kz.TOUCHES={};
kz.tween=function(a){var d=performance.now(),c=a.object[a.property],e=a.value,f=a.duration?a.duration:Math.abs(e-c)/a.rate;return new Promise(function(n){function y(){var w=(performance.now()-d)/f;1<=w?(a.object[a.property]=e,n()):(a.object[a.property]=w*e+(1-w)*c,window.requestAnimationFrame(y))}window.requestAnimationFrame(y)})};kz.events=[];kz.sendEvent=function(a){kz.events.push(a)};
kz.processEvents=function(){for(var a=0;a<kz.events.length;a++)for(var d in kz.entities)kz.entities[d].listen(kz.events[a]);kz.events=[]};kz.__entity_id__=0;
kz.Entity=function(a){for(name in a)a.hasOwnProperty(name)&&(this[name]=a[name]);if("number"!==typeof this.x)throw"Entity.x must be a number";if("number"!==typeof this.y)throw"Entity.y must be a number";if("function"!==typeof this.listen)throw"Entity.listen must be a function";this.__entity_id__=kz.__entity_id__;kz.entities[this.__entity_id__]=this;kz.__entity_id__++};kz.Entity.prototype.x=0;kz.Entity.prototype.y=0;kz.Entity.prototype.listen=function(){};kz.Entity.prototype.destroy=function(){delete kz.entities[this.__entity_id__]};
kz.Scene=function(a){a="undefined"!==typeof a?a:{};if("function"===typeof a.initialize)throw this.initialize=a.initialize,"Scene.initialize must be function";if("function"===typeof a.preUpdate)throw this.preUpdate=a.preUpdate,"Scene.preUpdate must be function";if("function"===typeof a.postUpdate)throw this.postUpdate=a.postUpdate,"Scene.postUpdate must be function";if("function"===typeof a.draw)throw this.draw=a.draw,"Scene.draw must be function";};kz.Scene.prototype.initialize=function(){};
kz.Scene.prototype.preUpdate=function(){};kz.Scene.prototype.postUpdate=function(){};kz.Scene.prototype.draw=function(){};kz.Scene.prototype.exit=function(){};kz.isSceneLike=function(a){return void 0!==a&&null!==a&&"function"===typeof a.initialize&&"function"===typeof a.preUpdate&&"function"===typeof a.postUpdate&&"function"===typeof a.draw};
kz.initializeCanvas=function(a){kz.canvas=document.getElementById(a);kz.context=kz.canvas.getContext("2d");kz.context.clearAll=function(){kz.context.clearRect(0,0,kz.canvas.width,kz.canvas.height)}};
kz.initialize=function(a){kz.initializeCanvas(a);document.addEventListener("keydown",function(a){a.preventDefault();0==kz.keys_status[a.which]?(kz.keys_status[a.which]=1,a.kztype="keypress"):a.kztype="keyheld";kz.events.push(a)});document.addEventListener("keyup",function(a){a.preventDefault();a.kztype="keyup";kz.keys_status[a.which]=0;kz.events.push(a)});document.addEventListener("touchstart",function(a){a.preventDefault();for(var c=0;c<a.touches.length;c++){var e=a.touches[c];kz.TOUCHES[e.identifier]||
(kz.TOUCHES[e.identifier]={initial:e,current:e})}console.log("touchstart:",a,JSON.stringify(kz.TOUCHES))});document.addEventListener("touchmove",function(a){a.preventDefault();for(var c=0;c<a.touches.length;c++){var e=a.touches[c];kz.TOUCHES[e.identifier]&&(kz.TOUCHES[e.identifier].current=e)}console.log("touchmove:",a,JSON.stringify(kz.TOUCHES))});document.addEventListener("touchend",function(a){a.preventDefault();for(var c in kz.TOUCHES){for(var e=!1,f=0;f<a.touches.length;f++)a.touches[f].identifier==
c&&(e=!0);if(!e){var e=kz.TOUCHES[c].initial.screenX,f=kz.TOUCHES[c].initial.screenY,n=kz.TOUCHES[c].current.screenX,y=kz.TOUCHES[c].current.screenY;20>Math.abs(e-n)+Math.abs(f-y)?kz.events.push({kztype:"keypress",which:kz.KEYS.Z}):40>Math.abs(f-y)&&20<e-n?kz.events.push({kztype:"keypress",which:kz.KEYS.LEFT}):40>Math.abs(f-y)&&20<n-e&&kz.events.push({kztype:"keypress",which:kz.KEYS.RIGHT});delete kz.TOUCHES[c]}}console.log("touchend:",a,JSON.stringify(kz.TOUCHES))})};
kz.tick=function(a){kz.scene.preUpdate(kz.performance.now());kz.scene.draw(kz.performance.now());kz.scene.postUpdate(kz.performance.now());window.requestAnimationFrame(kz.tick)};kz.run=function(a){kz.scene&&kz.scene.exit();if(!kz.isSceneLike(a))throw"No scene attached!";kz.entities={};kz.scene=a;kz.scene.initialize();kz.alive=!0;window.requestAnimationFrame(kz.tick)};kz.performance=Object.create(performance);kz.performance.pauseTime=0;
kz.performance.now=function(){return kz.paused?kz.pauseNow:performance.now()-kz.performance.pauseTime};kz.paused=!1;kz.pauseTime=0;kz.pause=function(){kz.pauseNow=kz.performance.now();kz.pauseTime=performance.now();kz.paused=!0};kz.resume=function(){kz.performance.pauseTime+=performance.now()-kz.pauseTime;kz.paused=!1};var scene_loading=new kz.Scene;
scene_loading.draw=function(a){kz.context.clearAll();kz.context.save();kz.context.fillStyle="#30403b";kz.context.fillRect(0,0,kz.canvas.width,kz.canvas.height);kz.context.restore();text=["LOADING","LOADING.","LOADING..","LOADING..."];kz.context.save();kz.context.textAlign="center";kz.context.textBaseline="center";kz.context.font="18px font";kz.context.fillStyle="#8ed4a5";kz.context.lineWidth=2;kz.context.fillText(text[Math.round(a/500)%4],kz.canvas.width/2,kz.canvas.height/2);kz.context.restore()};
var scene_main_menu=function(){var a,d=new kz.Scene,c;d.initialize=function(){c={press_space_visible:!0,blink:!0,text_alpha:1};a=!1};d.draw=function(){kz.context.clearAll();kz.context.save();kz.context.fillStyle="#30403b";kz.context.fillRect(0,0,kz.canvas.width,kz.canvas.height);kz.context.restore();c.press_space_visible&&(kz.context.save(),kz.context.globalAlpha=c.text_alpha,kz.context.textAlign="center",kz.context.textBaseline="center",kz.context.font="24px font",kz.context.fillStyle="white",kz.context.fillText("PRESS   Z",
kz.canvas.width/2,250),kz.context.restore());kz.context.save();kz.context.globalAlpha=c.text_alpha;kz.context.textAlign="center";kz.context.textBaseline="center";kz.context.font="10px font";kz.context.fillStyle="#50605b";kz.context.lineWidth=2;kz.context.fillText("HERMAN CHAU (KCAZE)",kz.canvas.width/2,380);kz.context.restore()};d.preUpdate=function(d){for(var f=0;f<kz.events.length;f++)"keypress"!=kz.events[f].kztype||kz.events[f].which!=kz.KEYS.Z||a||(a=!0,c.blink=!1,c.press_space_visible=!1,kz.tween({object:c,
property:"text_alpha",value:0,duration:500}).then(function(){setTimeout(function(){kz.run(scene_game)},500)}));kz.events=[];c.blink&&(c.press_space_visible=2>Math.floor(d/500)%4?!0:!1)};d.exit=function(){};return d}(),previous_time;
function roundRect(a,d,c,e,f,n,y,w){"undefined"==typeof w&&(w=!0);"undefined"===typeof n&&(n=5);a.beginPath();a.moveTo(d+n,c);a.lineTo(d+e-n,c);a.quadraticCurveTo(d+e,c,d+e,c+n);a.lineTo(d+e,c+f-n);a.quadraticCurveTo(d+e,c+f,d+e-n,c+f);a.lineTo(d+n,c+f);a.quadraticCurveTo(d,c+f,d,c+f-n);a.lineTo(d,c+n);a.quadraticCurveTo(d,c,d+n,c);a.closePath();w&&a.stroke();y&&a.fill()}
var scene_game=function(){function a(){return new Promise(function(a){a()})}function d(a){var b=a.length;return a[Math.floor(Math.random()*b)]}function c(b,c,d){return new kz.Entity({x:b,y:c,type:d,images:[e(d)],frameIndex:0,alpha:1,actions_promise:a()})}function e(a){switch(a){case q.Red:return kz.resources.images.piece_red;case q.Blue:return kz.resources.images.piece_blue}}function f(a){switch(a){case q.Red:return[kz.resources.images.piece_red,kz.resources.images.piece_red1,kz.resources.images.piece_red2];
case q.Blue:return[kz.resources.images.piece_blue,kz.resources.images.piece_blue1,kz.resources.images.piece_blue2]}}function n(){g.alive=!1;console.log("Lost :(");b.gameover_context.clearRect(0,0,b.gameover_canvas.width,b.gameover_canvas.height);b.gameover_context.drawImage(kz.canvas,0,0);kz.tween({object:b,property:"gameover_background_alpha",value:1,duration:1E3}).then(function(){return kz.tween({object:b,property:"gameover_text_alpha",value:1,duration:1E3})}).then(function(){g.can_restart=!0})}
function y(){for(var a,b=0;b<h.board_height;b++){var c=g.board[b][0].piece_type;if(c!=q.Empty){for(var d=!0,e=0;e<h.board_width;e++)if(g.board[b][e].piece_type!=c){d=!1;break}if(d){a=b;break}}}if("undefined"!==typeof a){c=[];for(e=0;e<h.board_width;e++)c.push(g.board[a][e].piece);for(b=a;b<h.board_height-1;b++)for(e=0;e<h.board_width;e++)g.board[b][e]=g.board[b+1][e];for(e=0;e<h.board_width;e++)g.board[h.board_height-1][e]={piece_type:q.Empty};g.score++;kz.resources.sounds.sfx_clear.play();var f=
[];c.forEach(function(a){f.push(a.actions_promise)});var f=Promise.all(f),k=[];c.forEach(function(a){var b=f.then(function(){return kz.tween({object:a,property:"alpha",value:0,duration:100}).then(function(){a.destroy()})});a.actions_promise=b;k.push(b)});for(b=a;b<h.board_height;b++)for(e=0;e<h.board_width;e++)(a=g.board[b][e].piece)&&function(a){var b=Promise.all(k.concat([a.actions_promise]));a.actions_promise=b.then(function(){return kz.tween({object:a,property:"y",value:a.y-h.grid_size,rate:1})})}(a)}}
function w(a,b){var c=[1,-1,0,0,1,1,-1,-1],d=[0,0,1,-1,1,-1,1,-1],k=g.board[b][a].piece_type;if(k!=q.Empty)for(var l=0;8>l;l++){for(var n=c[l],y=d[l],w=!1,x=1,v=a+x*n,A=b+x*y;0<=v&&0<=A&&v<h.board_width&&A<h.board_height&&g.board[A][v].piece_type!=q.Empty;){if(g.board[A][v].piece_type==k){w=!0;break}x++;v=a+x*n;A=b+x*y}if(w)for(w=1;w<x;w++)v=a+w*n,A=b+w*y,g.board[A][v].piece_type=k,function(a){a.images=f(a.type).concat(f(k).reverse());a.actions_promise=a.actions_promise.then(function(){return new Promise(function(b){var c;
c=setInterval(function(){a.frameIndex<a.images.length-1?a.frameIndex++:(a.type=k,a.frameIndex=0,a.images=[e(a.type)],clearInterval(c),b())},30)})})}(g.board[A][v].piece)}}function x(){for(var a=[],b=0;b<h.board_width;b++){var e=d(k);a.push({piece_type:e,piece:c(1+20*b,-19,e)})}for(b=0;b<h.board_width;b++){if(g.board[h.board_height-1][b].piece_type!=q.Empty){n();return}for(e=h.board_height-1;0<e;e--)g.board[e][b]=g.board[e-1][b];g.board[0][b]=a[b]}g.board.forEach(function(a){a.forEach(function(a){var b=
a.piece;b&&(b.actions_promise=b.actions_promise.then(function(){return kz.tween({object:b,property:"y",value:b.y+h.grid_size,rate:1})}))})})}function v(a){for(a=0;a<kz.events.length;a++)"keypress"==kz.events[a].kztype&&kz.events[a].which==kz.KEYS.Z&&g.can_restart&&kz.tween({object:b,property:"gameover_text_alpha",value:0,duration:1E3}).then(function(){kz.run(scene_main_menu)});kz.events=[]}var g,b,h={board_width:8,board_height:17,grid_size:20,next_length:4,next_row_interval:1E4},q={Empty:0,Red:1,
Blue:2},k=[q.Red,q.Blue],l=new kz.Scene;l.initialize=function(){kz.resources.sounds.bgm_game.play(!0);b={background_pattern:kz.context.createPattern(kz.resources.images.background,"repeat"),board_canvas:document.createElement("canvas"),info_canvas:document.createElement("canvas"),pause_canvas:document.createElement("canvas"),pause_alpha:0,gameover_canvas:document.createElement("canvas"),gameover_background_alpha:0,gameover_text_alpha:0};b.board_canvas.width=h.board_width*h.grid_size;b.board_canvas.height=
kz.canvas.height;b.board_context=b.board_canvas.getContext("2d");b.info_canvas.width=95;b.info_canvas.height=400;b.info_context=b.info_canvas.getContext("2d");b.gameover_canvas.width=400;b.gameover_canvas.height=400;b.gameover_context=b.gameover_canvas.getContext("2d");b.pause_canvas.width=400;b.pause_canvas.height=400;b.pause_context=b.pause_canvas.getContext("2d");g={alive:!0,board:[],can_restart:!1,score:0,level:1,next_row_interval:h.next_row_interval,next_row_time:0};g.next_row_time=kz.performance.now()+
g.next_row_interval;for(var e=0;e<h.board_height;e++){g.board.push([]);for(var f=0;f<h.board_width;f++)if(2>e){var m=d(k),l=c(1+20*f,1+20*e,m);g.board[e].push({piece_type:m,piece:l})}else g.board[e].push({piece_type:q.Empty})}g.player=new kz.Entity({frames:[kz.resources.images.shooter_0,kz.resources.images.shooter_1,kz.resources.images.shooter_2,kz.resources.images.shooter_3],frame_lengths:[500,200,200,200],current_frame:0,animate_timer:kz.performance.now(),animate:function(a){a-this.animate_timer>
this.frame_lengths[this.current_frame]&&(this.current_frame++,this.current_frame%=this.frames.length,this.animate_timer=a)},x:Math.floor(h.board_width/2),sprite_x:Math.floor(h.board_width/2)*h.grid_size,sprite_y:h.board_height*h.grid_size+23,actions_promise:a(),draw:function(a){a.drawImage(this.frames[this.current_frame],this.sprite_x,this.sprite_y);for(a=h.board_height-1;0<=a&&g.board[a][this.x].piece_type==q.Empty;a--);b.board_context.save();b.board_context.globalAlpha=1;b.board_context.lineWidth=
1;b.board_context.setLineDash([2,8]);b.board_context.strokeStyle="#8ed4a5";b.board_context.beginPath();b.board_context.moveTo(this.sprite_x+h.grid_size/2,this.sprite_y-8);b.board_context.lineTo(this.sprite_x+h.grid_size/2,(a+1)*h.grid_size+20);b.board_context.stroke();b.board_context.restore()},listen:function(a){if("keypress"==a.kztype)switch(a.which){case kz.KEYS.LEFT:this.move(-1);break;case kz.KEYS.RIGHT:this.move(1);break;case kz.KEYS.Z:this.shoot()}else if("keyheld"==a.kztype)switch(a.which){case kz.KEYS.LEFT:this.move(-1);
break;case kz.KEYS.RIGHT:this.move(1)}},move:function(b){0<=this.x+b&&this.x+b<h.board_width&&(this.x+=b,this.actions_promise=this.actions_promise.then(function(){return kz.tween({object:this,property:"sprite_x",value:this.sprite_x+b*h.grid_size,rate:.7}).then(function(){return a()}.bind(this))}.bind(this)))},next:[],shoot:function(){if(g.board[h.board_height-1][this.x].piece_type!=q.Empty)n();else{var a=this.next.shift();this.next.push(d(k));for(var b=h.board_height-1;0<b&&g.board[b-1][this.x].piece_type==
q.Empty;)b--;var e=c(this.x*h.grid_size+1,(h.board_height-1)*h.grid_size+1,a);g.board[b][this.x]={piece_type:a,piece:e};w(this.x,b);e.actions_promise=e.actions_promise.then(function(){kz.resources.sounds.sfx_shoot.play();return kz.tween({object:e,property:"y",value:1+20*b,rate:3})})}}});for(e=0;8>e;e++)g.player.next.push(d(k))};l.draw=function(a){if(kz.paused)kz.context.clearAll(),kz.context.save(),kz.context.globalAlpha=1,kz.context.drawImage(b.pause_canvas,0,0),kz.context.globalAlpha=b.pause_alpha,
kz.context.fillStyle="#000000",kz.context.fillRect(0,0,kz.canvas.width,kz.canvas.height),kz.context.restore();else if(g.alive){kz.context.clearAll();b.board_context.clearRect(0,0,b.board_canvas.width,b.board_canvas.height);b.info_context.clearRect(0,0,b.info_canvas.width,b.info_canvas.height);b.board_context.fillStyle="rgba(0,0,0,0.5)";b.board_context.fillRect(0,0,b.board_canvas.width,b.board_canvas.height);b.board_context.save();b.board_context.globalAlpha=1;b.board_context.lineWidth=1;b.board_context.strokeStyle=
"#50605b";b.board_context.beginPath();b.board_context.moveTo(0,h.board_height*h.grid_size+20);b.board_context.lineTo(h.board_width*h.grid_size,h.board_height*h.grid_size+20);b.board_context.stroke();b.board_context.restore();for(var c in kz.entities){var d=kz.entities[c];d.type&&(b.board_context.globalAlpha=d.alpha,b.board_context.drawImage(d.images[d.frameIndex],d.x,d.y+20))}b.board_context.globalAlpha=1;g.player.draw(b.board_context);b.board_context.fillStyle="rgba(0, 0, 0, 0.5)";b.board_context.fillRect(0,
8,b.board_canvas.width,5);b.board_context.fillStyle="rgba(142, 212, 165, 1)";b.board_context.fillRect(0,8,b.board_canvas.width*(g.next_row_time-a)/g.next_row_interval,5);b.info_context.fillStyle="rgba(0, 0, 0, 0.5)";b.info_context.fillRect(0,20,b.info_canvas.width,b.info_canvas.width);b.info_context.fillRect(0,185,b.info_canvas.width,50);b.info_context.fillRect(0,260,b.info_canvas.width,45);b.info_context.fillRect(0,335,b.info_canvas.width,45);b.info_context.textAlign="center";b.info_context.textBaseline=
"center";b.info_context.font="24px font";b.info_context.fillStyle="white";b.info_context.fillText("NEXT",50,205);b.info_context.fillText("SCORE",50,280);b.info_context.fillText("LEVEL",50,355);b.info_context.font="20px font";b.info_context.fillText(""+g.level,50,375);a=""+g.score;a="0".repeat(5-a.length)+a;b.info_context.fillText(a,50,300);for(a=0;a<h.next_length;a++)b.info_context.drawImage(e(g.player.next[a]),10+a*h.grid_size,212);kz.context.fillStyle=b.background_pattern;kz.context.fillRect(0,
0,kz.canvas.width,kz.canvas.height);kz.context.drawImage(b.board_canvas,10,0);kz.context.drawImage(b.info_canvas,10+b.board_canvas.width+10,0)}else kz.context.clearAll(),kz.context.save(),kz.context.globalAlpha=1,kz.context.drawImage(b.gameover_canvas,0,0),kz.context.globalAlpha=b.gameover_background_alpha,kz.context.fillStyle="#290000",kz.context.fillRect(0,0,kz.canvas.width,kz.canvas.height),kz.context.globalAlpha=b.gameover_text_alpha,kz.context.textAlign="center",kz.context.textBaseline="center",
kz.context.font="48px font",kz.context.strokeStyle="#ce0000",kz.context.fillStyle="#ffa100",kz.context.lineWidth=6,kz.context.strokeText("GAME OVER",kz.canvas.width/2,kz.canvas.height/2),kz.context.fillText("GAME OVER",kz.canvas.width/2,kz.canvas.height/2),kz.context.restore()};l.preUpdate=function(a){if(kz.paused){for(a=0;a<kz.events.length;a++)"keypress"==kz.events[a].kztype&&kz.events[a].which==kz.KEYS.ESCAPE&&kz.tween({object:b,property:"pause_alpha",value:0,duration:50}).then(kz.resume);kz.events=
[]}else if(g.alive)a:{for(var c=0;c<kz.events.length;c++)if("keypress"==kz.events[c].kztype&&kz.events[c].which==kz.KEYS.ESCAPE){kz.pause();b.pause_context.clearRect(0,0,b.pause_canvas.width,b.pause_canvas.height);b.pause_context.drawImage(kz.canvas,0,0);kz.tween({object:b,property:"pause_alpha",value:.75,duration:50});kz.events=[];break a}kz.processEvents();g.player.animate(a);g.next_row_time<a&&(x(),g.next_row_time=a+g.next_row_interval);y()}else v(a)};l.exit=function(){};return l}(),isMobile=!1;
if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,
4)))isMobile=!0;var audio_context=new AudioContext;function loadJSFXR(a,d){var c=new XMLHttpRequest;c.open("GET",a,!0);c.responseType="arraybuffer";c.onload=function(){audio_context.decodeAudioData(c.response,d)};c.send()}function loadSonant(a,d){(new sonantx.MusicGenerator(a)).createAudioBuffer(d)}
var resources={images:{background:"images/background.gif",piece_blue:"images/piece_blue0.gif",piece_blue1:"images/piece_blue1.gif",piece_blue2:"images/piece_blue2.gif",piece_red:"images/piece_red0.gif",piece_red1:"images/piece_red1.gif",piece_red2:"images/piece_red2.gif",shooter_0:"images/shooter0.gif",shooter_1:"images/shooter1.gif",shooter_2:"images/shooter2.gif",shooter_3:"images/shooter1.gif"},sounds:{sfx_shoot:{data:jsfxr([0,,.1881,,.3164,.8042,.2,-.2915,,,,,,.4661,.156,,.1754,-.182,1,,,.1755,
,.5]),loader:loadJSFXR},sfx_clear:{data:jsfxr([1,,.06,.4848,.4938,.8917,,,,,,,,,,,,,1,,,,,.49]),loader:loadJSFXR},bgm_game:{loader:loadSonant,data:{endPattern:382,songData:[{osc2_waveform:0,osc2_xenv:0,fx_pan_amt:108,osc2_vol:0,lfo_amt:187,lfo_osc1_freq:0,noise_fader:60,osc1_detune:0,osc2_oct:8,fx_filter:1,fx_resonance:120,fx_pan_freq:5,osc2_det:0,fx_delay_time:4,fx_freq:10332,lfo_waveform:0,osc1_vol:0,fx_delay_amt:16,osc1_waveform:0,notes:[147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,
0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,
0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0],lfo_fx_freq:0,osc2_detune:0,env_release:4607,env_sustain:419,osc1_xenv:0,lfo_freq:5,env_master:130,osc1_det:0,
env_attack:50,osc1_oct:8},{osc2_waveform:0,osc2_xenv:0,fx_pan_amt:0,osc2_vol:255,lfo_amt:96,lfo_osc1_freq:0,noise_fader:0,osc1_detune:0,osc2_oct:8,fx_filter:2,fx_resonance:60,fx_pan_freq:0,osc2_det:0,fx_delay_time:1,fx_freq:4067,lfo_waveform:0,osc1_vol:255,fx_delay_amt:45,osc1_waveform:0,notes:[160,0,160,0,155,0,0,0,148,160,162,0,163,162,160,0,163,0,163,162,163,0,151,163,165,0,0,0,167,0,165,0,167,0,163,0,162,0,163,0,156,0,151,162,158,0,0,0,151,0,155,0,151,0,150,0,151,0,150,0,151,0,150,155,160,0,160,
0,155,0,148,0,160,0,162,0,160,0,158,160,160,0,158,0,162,160,158,151,146,0,153,0,158,0,153,150,150,0,153,0,151,0,153,0,151,156,158,0,153,0,151,0,158,0,155,0,153,0,151,0,163,0,0,163,0,158,0,151,160,0,160,155,0,160,155,0,0,160,0,162,160,158,160,156,158,0,153,0,150,0,156,0,158,150,143,0,138,0,150,138,150,0,141,0,138,0,150,138,150,0,141,0,0,138,0,150,150,0,148,0,151,0,150,0,148,0,153,160,151,0,0,0,160,0,160,0,156,0,153,0,151,150,0,160,0,156,0,153,153,0,146,0,153,0,158,0,165,0,153,150,153,0,155,0,155,0,
153,155,153,0,151,0,153,0,153,0,151,0,153,0,153,0,158,0,160,0,158,0,151,146,151,0,0,0,153,0,163,0,0,0,163,160,163,0,156,0,151,163,170,0,167,163,170,0,160,0,151,163,170,0,167,163,170,0,160,0,0,0,160,0,0,0,170,0,168,0,167,0,0,167,0,170,0,168,168,0,167,0,165,0,167,0,168,0,165,0,0,168,0,165,163,0,163,156,0,0,151,0,0,151,0,156,0,158,0,156,158,0,151,144,156,158,0,151,144,158,0,151,144,156,158,0,158,0,155,0,158,153,151,0,153,165,153,0,148,0,146,0,146,0,153,0,148,0,151,0,155,0,158,0,155,0],lfo_fx_freq:1,
osc2_detune:0,env_release:13163,env_sustain:0,osc1_xenv:0,lfo_freq:3,env_master:255,osc1_det:0,env_attack:22,osc1_oct:7},{osc2_waveform:2,osc2_xenv:0,fx_pan_amt:0,osc2_vol:157,lfo_amt:0,lfo_osc1_freq:0,noise_fader:0,osc1_detune:0,osc2_oct:6,fx_filter:2,fx_resonance:76,fx_pan_freq:2,osc2_det:0,fx_delay_time:3,fx_freq:3900,lfo_waveform:0,osc1_vol:192,fx_delay_amt:0,osc1_waveform:2,notes:[160,0,148,0,160,0,148,0,160,172,148,160,172,172,148,0,146,0,170,0,158,158,170,146,158,158,158,146,158,146,0,156,
168,156,168,156,0,168,156,156,0,168,0,144,0,144,0,155,0,143,167,167,0,167,155,155,155,167,155,143,0,160,160,148,160,148,172,148,0,160,0,160,172,148,0,148,0,146,0,158,0,158,158,170,170,146,170,170,158,158,158,158,156,0,156,0,144,168,156,168,144,168,156,156,144,156,156,0,155,0,143,155,143,0,155,143,167,155,155,143,167,143,0,160,172,172,160,160,148,172,160,0,148,0,160,0,160,0,158,0,158,0,158,146,0,158,158,158,0,158,0,146,0,168,156,168,168,168,144,156,168,156,168,156,0,144,0,143,155,143,155,143,167,143,
155,167,0,155,0,155,0,155,0,148,160,160,0,172,0,148,0,160,160,148,0,160,160,0,146,0,170,0,158,0,146,0,158,0,146,0,146,0,158,0,156,156,156,0,144,0,168,168,144,0,156,168,156,156,144,0,143,155,143,0,143,0,155,0,143,155,167,167,155,0,143,0,151,0,163,0,151,0,151,0,163,0,151,0,151,163,151,0,160,0,148,0,172,160,148,0,160,172,148,160,148,0,160,0,144,168,168,168,144,0,156,156,156,0,156,0,144,168,168,158,0,158,0,146,0,158,0,158,0,158,170,146,158,158,0,151,0,163,175,175,0,163,163,163,151,175,151,0,151,0,160,
0,148,0,148,0,160,172,148,0,148,0,160,0,148,0,156,0,144,156,144,168,156,168,144,0,156,0,156,0,144,0,158,170,158,0,158,0,158,0,170,0,158,170],lfo_fx_freq:1,osc2_detune:0,env_release:12631,env_sustain:2418,osc1_xenv:0,lfo_freq:0,env_master:139,osc1_det:0,env_attack:0,osc1_oct:5}],rowLen:1739,songLen:46}}}};
window.onload=function(){var a=document.getElementById("fontHack");a.parentNode.removeChild(a);kz.initialize("canvas");kz.run(scene_loading);kz.loadResources(resources).then(function(){console.log("Loaded resources!");kz.run(scene_main_menu)})};
